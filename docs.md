# 1. はじめに

本ドキュメントは、STM32F103 ベースの自律飛行制御ファームウェアの概要、処理フロー、設計意図、コーディング規約、および用語解説をまとめたものです。新規メンバーが短期間でプロジェクト全体を理解し、開発・保守に参画できるよう設計されています。

# 2. アーキテクチャ概要

* **MCU**: STM32F103VET6 (Cortex-M3, 72 MHz)
* **センサ群**: MPU6000 (3軸加速度・ジャイロ), MAG3110 (3軸磁力), BMP280 (気圧)
* **通信**: I2C×2（センサ、Arduino），USART1＋DMA（テレメトリ）、XBee（無線）
* **制御ループ**: SysTick, TIM5\@50 Hz センサ読み出し → AHRS（Madgwick） → TIM6\@20 Hz PID制御 → TIM1/TIM4 PWM 出力
* **外部イベント**: EXTI 経由で RC 受信割込み、TIM2 で I2C 例外監視

# 3. コード構成

```
src/
 ├─ system/           // ボード初期化、クロック／GPIO／NVIC 設定
 ├─ drivers/          // I2C, USART, DMA, ADC ドライバ
 ├─ sensors/          // MPU6000, MAG3110, BMP280 の設定と取得関数
 ├─ control/          // MadgwickAHRS, PID, ロールレート制御
 ├─ comms/            // テレメトリ送信(sendDataOption, sendDataPID など)
 └─ main.c            // 全体の初期化とメインループ
```

# 4. 主な処理フロー

1. **起動・初期化**

   * `main()` で BoardInit, GPIO, SysTick, EXTI, NVIC, DMA, I2C, USART を順次設定
   * センサ接続チェック (`Sensor_ConnectionCheck`)
   * 各センサ初期化
2. **割込み駆動ループ**

   * **TIM5\_IRQHandler** @50 Hz: 各センサ読み出し + Madgwick AHRS 更新 + LED トグル
   * **TIM6\_IRQHandler** @20 Hz: AHRS の角度から PID 制御計算 → 出力角度を PWM 信号へ変換
   * **TIM8\_UP\_IRQHandler**: RC 受信データ取得 → 通常/自律モード切替、サーボ PWM 出力
   * **TIM2\_IRQHandler**: I2C 通信例外監視 → 必要時ログ出力 & 無限ループで停止
3. **テレメトリ**

   * DMA 経由で USART1 に各種データを送信 (センサ値、PID 出力、モード状態など)

# 5. 設計意図

* **リアルタイム性**: タイマー割込みを使った非同期ループで確実に周期制御
* **柔軟性**: ControlMode ごとに PID ゲインや目標値を切り換え可能
* **信頼性**: I2C 例外監視 + XBee 経由の受信確認で通信異常に対処
* **拡張性**: センサ、制御アルゴリズム、通信フォーマットの独立モジュール化

# 6. コーディング規約・書き方

* **マクロ定義**: `#define` で各種定数・レジスタアドレスを分かりやすく命名
* **関数名**: `<モジュール>_<機能>` 形式 (例: `MPU6000_getParameter`, `TIM5_IRQHandler`)
* **割込みハンドラ**: `XXX_IRQHandler` の命名規則を守り NVIC で優先度設定
* **エラーハンドリング**: I2C 例外は `exceptionPlace` + `I2Cexception` で特定後、ログ & 停止
* **コメント**: センサや演算アルゴリズム、重要なタイミング制御に対して必ず説明を併記

# 7. 用語解説

| 用語          | 意味・役割                                            |
| ----------- | ------------------------------------------------ |
| **I2C**     | Two-Wire シリアル通信プロトコル。センサとのマスタ/スレーブ通信に使用。         |
| **USART**   | UART ベースのシリアル通信。テレメトリ送信に DMA と組み合わせて使用。          |
| **DMA**     | メモリ⇔ペリフェラル間のデータ転送を CPU 介さず行う機構（USART、ADC などで利用）。 |
| **NVIC**    | 割込み制御機構。優先度設定や IRQ チャネル有効化を管理。                   |
| **EXTI**    | GPIO のピン状態変化を割込みとして扱う機能。RC 受信パルス幅計測に利用。          |
| **PWM**     | パルス幅変調。サーボモータの角度制御に用いる。TIM1/TIM4 で信号生成。          |
| **ADC**     | アナログ→デジタル変換。バッテリ電圧などの計測に DMA と組み合わせ使用可能。         |
| **SysTick** | システムタイマ。ソフトウェアディレイや全体時間管理に利用。                    |
| **AHRS**    | 姿勢推定アルゴリズム。Madgwick フィルタを用いて加速度・ジャイロ・磁力データを融合。   |
| **PID**     | 目標値と現在値の誤差を使ったフィードバック制御。P, I, D の三要素で出力を計算。      |

# 8. 参照

* STM32F1 リファレンスマニュアル
* 各センサデータシート (MPU6000, MAG3110, BMP280)
* Madgwick AHRS 論文
* STM32Cube HAL ドライバ (参考)
